# Fetch details of the merged PR that triggered this job
TRIGGERING_PR_NUMBER=$(curl -s -H "Authorization: token $SVC_GITHUB_TOKEN" \
    "https://api.github.com/repos/${CURRENT_REPO_OWNER}/${CURRENT_REPO}/commits/${CIRCLE_SHA1}" | jq -r '.commit.message' | grep -oP '#\K\d+')

# Get details of the triggering PR
TRIGGERING_PR_DETAILS=$(curl -s -H "Authorization: token $SVC_GITHUB_TOKEN" \
    "https://api.github.com/repos/${CURRENT_REPO_OWNER}/${CURRENT_REPO}/pulls/${TRIGGERING_PR_NUMBER}")

MERGED_BY=$(echo "$TRIGGERING_PR_DETAILS" | jq -r '.merged_by.login')
TRIGGERING_PR_URL=$(echo "$TRIGGERING_PR_DETAILS" | jq -r '.html_url')

# Create the body for the PR with the decoration details
PR_BODY="Updating the ${IMAGE_PATH} to ${IMAGE_TAG} version.

**Details of the triggering PR in ${CURRENT_REPO}:**
- **Merged By**: ${MERGED_BY}
- **PR URL**: [${TRIGGERING_PR_URL}](${TRIGGERING_PR_URL})

Please review the changes."

# Create a PR in the target repository
PR_API_RESPONSE_CODE=$(curl -o response.json -s -w "%{http_code}" -X POST \
    -H "Authorization: token $SVC_GITHUB_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{
          "title": "Updating the '"${IMAGE_PATH}"' to '"${IMAGE_TAG}"' version",
          "body": "'"$PR_BODY"'",
          "base": "master",
          "head": "'"${SVC_GITHUB_ALIAS}:${BRANCH}"'"
        }' "https://api.github.com/repos/${TARGET_REPO_OWNER}/${TARGET_REPO}/pulls")

# Handle the API response
if [ "$PR_API_RESPONSE_CODE" -lt 200 ] || [ "$PR_API_RESPONSE_CODE" -ge 300 ] && [ "$PR_API_RESPONSE_CODE" -ne 422 ]; then
    echo "API request failed with status code $PR_API_RESPONSE_CODE"
    cat response.json
    exit 1
fi

if [ "$PR_API_RESPONSE_CODE" -eq 422 ]; then
    ERROR_MESSAGE=$(cat response.json | jq -r '.errors[0].message')
    echo "$ERROR_MESSAGE"
    if [[ "$ERROR_MESSAGE" == *"A pull request already exists for"* ]]; then
        echo "Pull request already exists"
    else
        echo "API request failed with status code $PR_API_RESPONSE_CODE"
        exit 1
    fi
else
    PR_URL=$(cat response.json | jq -r '.html_url')
    echo "Pull request created successfully: $PR_URL"
fi
