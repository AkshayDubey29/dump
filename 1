def generate_graph(df):
    """Generate trend graph and return as HTML img tag."""
    try:
        # Check if the DataFrame is empty
        if df.empty or 'Start Time' not in df.columns:
            logger.error("DataFrame is empty or missing 'Start Time' column. Cannot generate graph.")
            return "<p>No data available to generate the graph.</p>"

        # Ensure 'Start Time' is in datetime format
        if not pd.api.types.is_datetime64_any_dtype(df['Start Time']):
            df['Start Time'] = pd.to_datetime(df['Start Time'], errors='coerce')

        # Drop rows where 'Start Time' is NaT
        df = df.dropna(subset=['Start Time'])

        # Group data by Start Time for trend analysis
        plt.figure(figsize=(10, 5))
        df['Start Time'].dt.floor('H').value_counts().sort_index().plot(
            kind='line', title='Incidents Over Time'
        )
        plt.xlabel('Time')
        plt.ylabel('Number of Incidents')

        # Save graph to a buffer
        buffer = BytesIO()
        plt.savefig(buffer, format="png")
        buffer.seek(0)

        # Encode image in Base64 for embedding
        image_base64 = base64.b64encode(buffer.read()).decode('utf-8')
        buffer.close()
        plt.close()
        
        return f'<img src="data:image/png;base64,{image_base64}" />'
    except Exception as e:
        logger.error(f"Failed to generate graph: {e}")
        return "<p>Error generating graph.</p>"
