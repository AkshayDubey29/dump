# Debugging TRIGGERING_PR_DETAILS
echo "Here=2"
echo "TRIGGERING_PR_DETAILS:"
echo "$TRIGGERING_PR_DETAILS"

# Extract Merged By and PR URL
MERGED_BY=$(echo "$TRIGGERING_PR_DETAILS" | jq -r '.merged_by.login')
TRIGGERING_PR_URL=$(echo "$TRIGGERING_PR_DETAILS" | jq -r '.url')

# Debug parsed values
echo "Merged By: $MERGED_BY"
echo "Triggering PR URL: $TRIGGERING_PR_URL"

# Create the body for the PR with the decoration details
PR_BODY=$(cat <<EOF
Updating the ${IMAGE_PATH} to ${IMAGE_TAG} version.

**Details of the triggering PR in ${CURRENT_REPO}:**
- **Merged By**: ${MERGED_BY}
- **PR URL**: [${TRIGGERING_PR_URL}](${TRIGGERING_PR_URL})

Please review the changes.
EOF
)

# Debugging the constructed PR body
echo "Constructed PR_BODY:"
echo "$PR_BODY"

# Create a PR in the target repository
PR_API_RESPONSE_CODE=$(curl -o response.json -s -w "%{http_code}" -X POST \
    -H "Authorization: token $SVC_GITHUB_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{
          "title": "Updating the '"${IMAGE_PATH}"' to '"${IMAGE_TAG}"' version",
          "body": "'"$PR_BODY"'",
          "base": "master",
          "head": "'"${SVC_GITHUB_ALIAS}:${BRANCH}"'"
        }' "https://github.coupang.net/api/v3/repos/coupang/coupang_deployment/pulls")

# Handle the API response
if [ "$PR_API_RESPONSE_CODE" -lt 200 ] || [ "$PR_API_RESPONSE_CODE" -ge 300 ] && [ "$PR_API_RESPONSE_CODE" -ne 422 ]; then
    echo "API request failed with status code $PR_API_RESPONSE_CODE"
    cat response.json
    exit 1
fi

if [ "$PR_API_RESPONSE_CODE" -eq 422 ]; then
    ERROR_MESSAGE=$(cat response.json | jq -r '.errors[0].message')
    echo "$ERROR_MESSAGE"
    if [[ "$ERROR_MESSAGE" == *"A pull request already exists for"* ]]; then
        echo "Pull request already exists"
    else
        echo "API request failed with status code $PR_API_RESPONSE_CODE"
        exit 1
    fi
else
    PR_URL=$(cat response.json | jq -r '.html_url')
    echo "Pull request created successfully: $PR_URL"
fi
