# Get the last tag or previous commit hash
PREVIOUS_REF=$(git describe --tags --abbrev=0 2>/dev/null || git rev-parse HEAD~1)

# Debugging the previous reference
echo "Previous Reference: $PREVIOUS_REF"

# Get the current commit hash or branch reference
CURRENT_REF=$(git rev-parse HEAD)

# Debugging the current reference
echo "Current Reference: $CURRENT_REF"

# Fetch the commits between the previous and current refs
CHANGELOG=$(git log $PREVIOUS_REF..$CURRENT_REF --pretty=format:"- %s (%an)" --no-merges)

# Debugging the ChangeLog
echo "Generated ChangeLog:"
echo "$CHANGELOG"

# Handle empty ChangeLog (in case there are no commits)
if [ -z "$CHANGELOG" ]; then
    CHANGELOG="No changes detected between $PREVIOUS_REF and $CURRENT_REF."
fi

# Create the PR body including the ChangeLog
PR_BODY=$(cat <<EOF
Updating the ${IMAGE_PATH} to ${IMAGE_TAG} version.

**Details of the triggering PR in ${CURRENT_REPO}:**
- **Merged By**: ${MERGED_BY}
- **PR URL**: [${TRIGGERING_PR_URL}](${TRIGGERING_PR_URL})

**ChangeLog:**
$CHANGELOG

Please review the changes.
EOF
)

# Debugging the constructed PR_BODY
echo "Constructed PR_BODY:"
echo "$PR_BODY"

# Create a PR in the target repository
PR_API_RESPONSE_CODE=$(curl -o response.json -s -w "%{http_code}" -X POST \
    -H "Authorization: token $SVC_GITHUB_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{
          "title": "Updating the '"${IMAGE_PATH}"' to '"${IMAGE_TAG}"' version",
          "body": "'"$PR_BODY"'",
          "base": "master",
          "head": "'"${SVC_GITHUB_ALIAS}:${BRANCH}"'"
        }' "https://github.coupang.net/api/v3/repos/coupang/coupang_deployment/pulls")

# Handle the API response
if [ "$PR_API_RESPONSE_CODE" -lt 200 ] || [ "$PR_API_RESPONSE_CODE" -ge 300 ] && [ "$PR_API_RESPONSE_CODE" -ne 422 ]; then
    echo "API request failed with status code $PR_API_RESPONSE_CODE"
    cat response.json
    exit 1
fi

if [ "$PR_API_RESPONSE_CODE" -eq 422 ]; then
    ERROR_MESSAGE=$(cat response.json | jq -r '.errors[0].message')
    echo "$ERROR_MESSAGE"
    if [[ "$ERROR_MESSAGE" == *"A pull request already exists for"* ]]; then
        echo "Pull request already exists"
    else
        echo "API request failed with status code $PR_API_RESPONSE_CODE"
        exit 1
    fi
else
    PR_URL=$(cat response.json | jq -r '.html_url')
    echo "Pull request created successfully: $PR_URL"
fi
